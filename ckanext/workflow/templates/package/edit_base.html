{% ckan_extends %}

{% block content_action %}
{% if pkg is defined %}
  {% set wf_stage = h.get_stage_from_package(pkg) %}
  {% if wf_stage  %}
    {% if  wf_stage.reject() is none and h.check_access('purge_unpublished_dataset', pkg) %}
      <a class="btn" href="{{ h.url_for('workflow.purge_unpublished_dataset', id=pkg.name) }}">{{ _('Purge') }}</a>
    {% endif %}

    {% if  wf_stage.reject() is not none and h.check_access('workflow_rescind_dataset', pkg) %}
      <a class="btn" href="{{ h.url_for('workflow.workflow_rescind', id=pkg.name) }}">{{ _('Rescind') }}</a>
    {% endif %}

    {% if h.check_access('move_to_next_stage', pkg) and wf_stage.approve() %}
      <a class="btn" href="{{ h.url_for('workflow.workflow_approve', id=pkg.name) }}">{{ _(wf_stage.approval_msg) }}</a>
    {% endif %}
    {% if h.check_access('move_to_next_stage', pkg) and wf_stage.reject()  %}
      {% if wf_stage.rejection_effect %}

        <a class="btn" href="#rejection-modal"
          {% if h.check_ckan_version(min_version="2.10") %}
            data-bs-toggle="modal"
          {% else %}
            data-dismiss="modal"
          {% endif %}
          >{{ _(wf_stage.reject_msg) }}
        </a>

      {% else %}
        <a class="btn" href="{{ h.url_for('workflow.workflow_reject', id=pkg.name) }}">{{  _(wf_stage.reject_msg) }}</a>
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}

  {{ super() }}
{% endblock %}


{% block primary %}
  {{ super() }}

  <div class="modal fade" id="rejection-modal" aria-hidden="true" style="display:none">
    <div class="modal-dialog">
      <div class="modal-content">
	<div class="modal-header">

	  <button type="button" class="close" aria-hidden="true"
      {% if h.check_ckan_version(min_version="2.10") %}
          data-bs-dismiss="modal"
      {% else %}
          data-dismiss="modal"
      {% endif %}
          >&times;
    </button>

	  <h4 class="modal-title">Confirmation</h4>
	</div>
	<div class="modal-body row">
    {% if pkg is defined %}
      <form action="{{ h.url_for('workflow.workflow_reject', id=pkg.name) }}" method="POST" id="reason-of-rejection">
    {% endif %}
	      <label for="reason-text" class="col-sm-3 control-label">Provide a reason of this action</label>
	      <div class="col-sm-9">
		      <textarea name="reason" id="reason-text" class="form-control"  cols="60" style="resize:none" rows="3" required="required"></textarea>
	      </div>
      </form>
	</div>
	<div class="modal-footer">
  
	  <button type="button" class="btn btn-default"
        {% if h.check_ckan_version(min_version="2.10") %}
          data-bs-dismiss="modal"
        {% else %}
          data-dismiss="modal"
        {% endif %}
          >Close
      </button>

	  <button type="submit" form="reason-of-rejection" class="btn btn-primary">Confirm</button>
	</div>
      </div>
    </div>
  </div>

{% endblock %}
